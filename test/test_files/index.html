<!DOCTYPE html>
<html>

<head>
    <script src="https://code.jquery.com/jquery-1.12.2.min.js"></script>
    <script src="airtable.browser.js"></script>
</head>

<body>
    <h1>Artists</h1>
    <div id="artists"></div>

    <hr />
    <button id='create'>Create</button>
    <div id="created"></div>
</body>


<script>
    // find the apiKey here https://airtable.com/create/tokens it's called a token now
    var apiKey = 'patFU3geSy4szjxDL.673932aecfed18a6280affbaccfa7f2d79d9ef45fecbd2607ac4d1470c7f6d07'
    // find the baseId, go here https://airtable.com/developers/web/api/introduction  then click on the base you want to use and the base id is in the url
    var baseId = 'appq7pl4mHoUefVWb'
    // get base id and api key from the url
    var url = new URL(window.location.href);
    if (url.searchParams.get("api_key")) {
        apiKey = url.searchParams.get("api_key");
    }
    if (url.searchParams.get("base_id")) {
        baseId = url.searchParams.get("base_id");
    }
    // ask for api key and base id if not provided
    if (!apiKey) {
        apiKey = prompt('Enter your Airtable API key');
    }
    if (!baseId) {
        baseId = prompt('Enter your Airtable base ID');
    }
    if (!apiKey || !baseId) {
        alert('You must provide an API key and base ID to use this example.');
    }
    var Airtable = require('airtable');
    // Get a base ID for an instance of art gallery example
    var base = new Airtable({
        endpointUrl: 'https://api.airtable.com',
        apiKey: apiKey
    }).base(
        baseId
    );

    var deleteArtist = function (record) {
        record.destroy(function (err) {
            if (err) {
                console.log('Error destroying ', recordId, err);
            } else {
                console.log('Destroyed ', record.getId());
                $('div[data-record-id="' + record.getId() + '"]').remove();
            }
        });
    };

    var loadArtists = function () {
        $('#artists').empty();

        base('Artists').select({
            sort: [
                { field: 'Name', direction: 'asc' }
            ]
        }).eachPage(function page(records, fetchNextPage) {
            records.forEach(function (record) {
                console.log('Retrieved ', record.get('Name'));

                var $artistInfo = $('<div>');
                $artistInfo.append($('<h3>').text(record.get('Name')));
                $artistInfo.append($('<div>').text(record.get('Bio')));
                $artistInfo.append($('<div>').text(record.get('Genre').join(', ')));
                $artistInfo.append($('<div>').text(record.get('On Display?') ? 'On Display' : 'Not on Display'));
                var x = $('<button>').text('Delete').click(function () {
                    deleteArtist(record);
                });
                $artistInfo.append(x)
                $artistInfo.attr('data-record-id', record.getId());

                $('#artists').append($artistInfo);
            });

            fetchNextPage();
        }, function done(error) {
            console.log(error);
        });
    };

    $('#create').click(function () {
        base('Artists').create({
            "Name": "Al Held",
            "Bio": "Al Held began his painting career by exhibiting Abstract Expressionist works in New York; he later turned to hard-edged geometric paintings that were ...",
            "Genre": [
                "American Abstract Expressionism",
                "Color Field"
            ],
            "On Display?": true
        }, function (err, record) {
            if (err) { console.log(err); return; }
            loadArtists();
        });
    });

    loadArtists();

</script>

</html>
