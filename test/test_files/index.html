<!DOCTYPE html>
<html>

<head>
    <script src="https://code.jquery.com/jquery-1.12.2.min.js"></script>
    <script src="airtable.browser.js"></script>
</head>

<body>
    <h1>Artists</h1>
    <hr />
    <fieldset>
        <legend>
            <span id="operationTypeUpdate">
                Update
            </span>
            <span id="operationTypeCreate">
                Create
            </span>
            Artist Record
            <span id="recordId"></span>
        </legend>
        <div id="inputs">
        </div>
        <br>
        <button id='buttonToCreateArtist'>Create</button>
        <button id="buttonToUpdateArtist">Update</button>
        <button id="buttonToClearFieldSet">Clear</button>
    </fieldset>
    <hr />
    <table>
        <thead id="artistTableHead"></thead>
        <tbody id="artists"></tbody>
    </table>
    <hr>

</body>



<script>
    // find the apiKey here https://airtable.com/create/tokens it's called a token now
    var apiKey = ''
    // find the baseId, go here https://airtable.com/developers/web/api/introduction  then click on the base you want to use and the base id is in the url
    var baseId = 'appq7pl4mHoUefVWb'
    // get base id and api key from the url
    var url = new URL(window.location.href);
    if (url.searchParams.get("api_key")) {
        apiKey = url.searchParams.get("api_key");
    }
    if (url.searchParams.get("base_id")) {
        baseId = url.searchParams.get("base_id");
    }
    // ask for api key and base id if not provided
    if (!apiKey) {
        apiKey = prompt('Enter your Airtable API key');
    }
    if (!baseId) {
        baseId = prompt('Enter your Airtable base ID');
    }
    if (!apiKey || !baseId) {
        alert('You must provide an API key and base ID to use this example.');
    }
    var Airtable = require('airtable');
    // Get a base ID for an instance of art gallery example
    var base = new Airtable({
        endpointUrl: 'https://api.airtable.com',
        apiKey: apiKey
    }).base(
        baseId
    );

    const capitalize = (s) => {
        if (typeof s !== 'string') return ''
        return s.charAt(0).toUpperCase() + s.slice(1)
    }

    const getIdOfField = (field) => {
        // return 'artist' + capitalize(field.name).replace(/\s/g, '');
        // replace everything not a letter or number with ''
        return 'artist' + field.name.replace(/[^a-zA-Z0-9]/g, '');
    }

    var renderFieldInput = function (field) {
        if (field.type === "singleLineText") {
            return $('<input>').attr('type', 'text').attr('id', getIdOfField(field)).attr('placeholder', field.name);
        } else if (field.type === "multilineText") {
            return $('<textarea>').attr('id', getIdOfField(field)).attr('placeholder', field.name);
        } else if (field.type === "multipleSelects") {
            return $('<select>')
                .attr('id', getIdOfField(field))
                .attr('multiple', true)
                .attr('size',
                    field.options.choices.length
                )
        } else if (field.type === "checkbox") {
            return $('<span>').attr('class', 'checkbox-wrapper').append($('<input>').attr('type', 'checkbox').attr('id', getIdOfField(field))).append($('<label>').attr('for', getIdOfField(field)).text(field.name));
        } else if (field.type === "lastModifiedTime") {
            return $('<input>').attr('type', 'datetime-local').attr('id', getIdOfField(field)).attr('disabled', true);
        } else if (field.type === "createdTime") {
            return $('<input>').attr('type', 'datetime-local').attr('id', getIdOfField(field)).attr('disabled', true);
        }
    }

    var renderFieldsInputs = function (fields) {
        $('#inputs').empty();
        fields.forEach(function (field) {
            $('#inputs').append(renderFieldInput(field));
        });
    }

    var genres = []
    var tableFields = []
    var getTables = function () {
        $.ajax({
            url: 'https://api.airtable.com/v0/meta/bases/' + baseId + '/tables',
            type: 'GET',
            headers: {
                'Authorization': 'Bearer ' + apiKey
            },
            success: function (data) {
                console.log('tables', data);
                renderFieldsInputs(data.tables[0].fields);
                tableFields = data.tables[0].fields.map(f => f.name);
                if (!tableFields.includes('Updated At')) {
                    alert('You must have an "Updated At" field in your table otherwise this example will not work.');
                }
                $('thead').empty();
                tableFields.forEach(function (field) {
                    $('thead').append($('<th>').text(field));
                });
                genres = data.tables[0]
                    .fields
                    .find(function (field) {
                        return field.name === 'Genre';
                    })
                    ?.options.choices.map(c => c.name);
                console.log('genres', genres);
                $('#artistGenre').empty();
                genres.forEach(function (genre) {
                    $('#artistGenre').append($('<option>').val(genre).text(genre));
                });

            }
        });
    }

    getTables();

    var deleteArtist = function (record) {
        var sure = confirm('Are you sure you want to delete ' + record.get('Name') + '?');
        if (!sure) {
            return;
        }
        record.destroy(function (err) {
            if (err) {
                console.log('Error destroying ', recordId, err);
            } else {
                console.log('Destroyed ', record.getId());
                $('[data-record-id="' + record.getId() + '"]').remove();
            }
        });
    };

    var updateArtist = function () {
        var updatedRecord = {
            "Name": $('#artistName').val(),
            "Bio": $('#artistBio').val(),
            "Genre": $('#artistGenre').val(),
            "On Display?": $('#artistOnDisplay').prop('checked')
        }
        base('Artists')
            .update(
                selectedRecordId,
                updatedRecord
                , function (err, record) {
                    if (err) {
                        console.log('Error updating ', selectedRecordId, err);
                    } else {
                        console.log('Updated ', record.getId());
                        loadArtists();
                    }
                }
            );
    };

    $('#buttonToUpdateArtist').click(function () {
        updateArtist();
    });



    var clearFieldSet = function () {
        $('#operationTypeUpdate').hide();
        $('#operationTypeCreate').show();
        $('#buttonToUpdateArtist').hide();
        $('#buttonToCreateArtist').show();
        selectedRecordId = null;
        $('#recordId').text('');
        $('#artistName').val('');
        $('#artistBio').val('');
        $('#artistGenre').val('');
        $('#artistOnDisplay').prop('checked', false);
        $('#artistCreatedAt').val('');
        $('#artistUpdatedAt').val('');
    };

    clearFieldSet();

    $('#buttonToClearFieldSet').click(function () {
        clearFieldSet();
    });

    var selectedRecordId = null;

    function convertTimeForInputWithUTCOffset(
        dateTimeString
        // example: 2024-03-16T19:53:46.000Z
    ) {
        const date = new Date(dateTimeString);
        const options = {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false,
            timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
        };
        console.log(date)
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        const formattedDate = `${year}-${month}-${day}T${hours}:${minutes}`
        return formattedDate;
    }

    var editRecord = function (record) {
        $('#operationTypeUpdate').show();
        $('#operationTypeCreate').hide();
        $('#buttonToUpdateArtist').show();
        $('#buttonToCreateArtist').hide();
        selectedRecordId = record.getId();
        $('#recordId').text(selectedRecordId);
        $('#artistName').val(record.get('Name'));
        $('#artistBio').val(record.get('Bio'));
        $('#artistGenre').val(record.get('Genre'));
        $('#artistOnDisplay').prop('checked', record.get('On Display?'));
        var createdAt = convertTimeForInputWithUTCOffset(record.get('Created At'));
        $('#artistCreatedAt').val(createdAt)
        var updatedAt = convertTimeForInputWithUTCOffset(record.get('Updated At'));
        $('#artistUpdatedAt').val(updatedAt)
    }

    function convertTimeToHumanReadable(
        dateTimeString
        // example: 2024-03-16T19:53:46.000Z
    ) {
        const date = new Date(dateTimeString);
        const options = {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false,
            timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
        };
        return date.toLocaleDateString(
            Intl.DateTimeFormat().resolvedOptions().locale, options
        );
    }

    const renderRecord = function (record) {
        console.log('Retrieved ', record.get('Name'));

        var $artistInfo = $('<tr>');
        $artistInfo.append($('<h3>').text(record.get('Name')));
        $artistInfo.append($('<td>').text(record.get('Bio')));
        $artistInfo.append($('<td>').append($('<ul>').append(record.get('Genre')?.map(g => $('<li>').text(g)))))
        $artistInfo.append($('<td>').append($('<input>').attr('type', 'checkbox').prop('checked', record.get('On Display?')).prop('disabled', true)));
        var createdAt = convertTimeToHumanReadable(record.get('Created At'));
        $artistInfo.append($('<td>').text(createdAt));
        var updatedAt = convertTimeToHumanReadable(record.get('Updated At'));
        $artistInfo.append($('<td>').text(updatedAt));
        var x = $('<button>').text('Delete').click(function () {
            deleteArtist(record);
        });
        var y = $('<button>').text('Edit Record').click(function () {
            editRecord(record);
        });
        $artistInfo.append(x)
        $artistInfo.append(y)
        $artistInfo.attr('data-record-id', record.getId());

        $('#artists').append($artistInfo);
    }

    var loadArtists = function () {
        $('#artists').empty();

        base('Artists')
            .select({
                sort: [
                    { field: 'Updated At', direction: 'desc' }
                ]
            })
            .eachPage(function page(records, fetchNextPage) {
                records.forEach(function (record) {
                    renderRecord(record)
                });

                fetchNextPage();
            }, function done(error) {
                console.log(error);
            });
    };




    $('#buttonToCreateArtist').click(function () {
        var newRecord = {
            "Name": $('#artistName').val(),
            "Bio": $('#artistBio').val(),
            "Genre": $('#artistGenre').val(),
            "On Display?": $('#artistOnDisplay').prop('checked')
        }
        base('Artists')
            .create(
                newRecord
                , function (err, record) {
                    if (err) {
                        console.log('Error updating ', selectedRecordId, err);
                        alert('Error creating record: ' + err)
                    } else {
                        console.log('Updated ', record.getId());
                        loadArtists();
                    }
                },

            );
    });

    loadArtists();

    // https://airtable.com/developers/web/api/get-base-schema
    // curl "https://api.airtable.com/v0/meta/bases/{baseId}/tables" \-H "Authorization: Bearer YOUR_TOKEN"



</script>

</html>
