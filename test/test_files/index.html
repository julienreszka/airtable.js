<!DOCTYPE html>
<html>

<head>
    <script src="https://code.jquery.com/jquery-1.12.2.min.js"></script>
    <script src="airtable.browser.js"></script>
</head>

<body>
    <h1>Artists</h1>
    <hr />
    <fieldset>
        <legend>
            <span id="operationTypeUpdate">
                Update
            </span>
            <span id="operationTypeCreate">
                Create
            </span>
            Artist Record
            <span id="recordId"></span>
        </legend>
        <input type="text" id="artistName" placeholder="Name" />
        <input type="text" id="artistBio" placeholder="Bio" />
        <select id="artistGenre" multiple size="3">
        </select>
        <input type="checkbox" id="artistOnDisplay" />
        <button id='buttonToCreateArtist'>Create</button>
        <button id="buttonToUpdateArtist">Update</button>
        <button id="buttonToClearFieldSet">Clear</button>
    </fieldset>
    <hr />
    <table>
        <thead id="artistTableHead"></thead>
        <tbody id="artists"></tbody>
    </table>
    <hr>

</body>


<script>
    // find the apiKey here https://airtable.com/create/tokens it's called a token now
    var apiKey = ''
    // find the baseId, go here https://airtable.com/developers/web/api/introduction  then click on the base you want to use and the base id is in the url
    var baseId = 'appq7pl4mHoUefVWb'
    // get base id and api key from the url
    var url = new URL(window.location.href);
    if (url.searchParams.get("api_key")) {
        apiKey = url.searchParams.get("api_key");
    }
    if (url.searchParams.get("base_id")) {
        baseId = url.searchParams.get("base_id");
    }
    // ask for api key and base id if not provided
    if (!apiKey) {
        apiKey = prompt('Enter your Airtable API key');
    }
    if (!baseId) {
        baseId = prompt('Enter your Airtable base ID');
    }
    if (!apiKey || !baseId) {
        alert('You must provide an API key and base ID to use this example.');
    }
    var Airtable = require('airtable');
    // Get a base ID for an instance of art gallery example
    var base = new Airtable({
        endpointUrl: 'https://api.airtable.com',
        apiKey: apiKey
    }).base(
        baseId
    );

    var genres = []
    var tableFields = []
    var getTables = function () {
        $.ajax({
            url: 'https://api.airtable.com/v0/meta/bases/' + baseId + '/tables',
            type: 'GET',
            headers: {
                'Authorization': 'Bearer ' + apiKey
            },
            success: function (data) {
                console.log('tables', data);
                tableFields = data.tables[0].fields.map(f => f.name);
                $('thead').empty();
                tableFields.forEach(function (field) {
                    $('thead').append($('<th>').text(field));
                });
                genres = data.tables[0]
                    .fields
                    .find(function (field) {
                        return field.name === 'Genre';
                    })
                    ?.options.choices.map(c => c.name);
                console.log('genres', genres);
                $('#artistGenre').empty();
                genres.forEach(function (genre) {
                    $('#artistGenre').append($('<option>').val(genre).text(genre));
                });

            }
        });
    }

    getTables();

    var deleteArtist = function (record) {
        record.destroy(function (err) {
            if (err) {
                console.log('Error destroying ', recordId, err);
            } else {
                console.log('Destroyed ', record.getId());
                $('[data-record-id="' + record.getId() + '"]').remove();
            }
        });
    };

    var updateArtist = function () {
        var updatedRecord = {
            "Name": $('#artistName').val(),
            "Bio": $('#artistBio').val(),
            "Genre": $('#artistGenre').val(),
            "On Display?": $('#artistOnDisplay').prop('checked')
        }
        base('Artists')
            .update(
                selectedRecordId,
                updatedRecord
                , function (err, record) {
                    if (err) {
                        console.log('Error updating ', selectedRecordId, err);
                    } else {
                        console.log('Updated ', record.getId());
                        loadArtists();
                    }
                }
            );
    };

    $('#buttonToUpdateArtist').click(function () {
        updateArtist();
    });



    var clearFieldSet = function () {
        $('#operationTypeUpdate').hide();
        $('#operationTypeCreate').show();
        $('#buttonToUpdateArtist').hide();
        $('#buttonToCreateArtist').show();
        selectedRecordId = null;
        $('#recordId').text('');
        $('#artistName').val('');
        $('#artistBio').val('');
        $('#artistGenre').val('');
        $('#artistOnDisplay').prop('checked', false);
    };

    clearFieldSet();

    $('#buttonToClearFieldSet').click(function () {
        clearFieldSet();
    });

    var selectedRecordId = null;

    var editRecord = function (record) {
        $('#operationTypeUpdate').show();
        $('#operationTypeCreate').hide();
        $('#buttonToUpdateArtist').show();
        $('#buttonToCreateArtist').hide();
        selectedRecordId = record.getId();
        $('#recordId').text(selectedRecordId);
        $('#artistName').val(record.get('Name'));
        $('#artistBio').val(record.get('Bio'));
        $('#artistGenre').val(record.get('Genre'));
        $('#artistOnDisplay').prop('checked', record.get('On Display?'));
    }

    const renderRecord = function (record) {
        console.log('Retrieved ', record.get('Name'));

        var $artistInfo = $('<tr>');
        $artistInfo.append($('<h3>').text(record.get('Name')));
        $artistInfo.append($('<td>').text(record.get('Bio')));
        // $artistInfo.append($('<td>').text(record.get('Genre')?.join(', ')));
        // TODO instead of join make a ul li list of genres
        $artistInfo.append($('<td>').append($('<ul>').append(record.get('Genre')?.map(g => $('<li>').text(g)))))
        $artistInfo.append($('<td>').append($('<input>').attr('type', 'checkbox').prop('checked', record.get('On Display?')).prop('disabled', true)));
        var x = $('<button>').text('Delete').click(function () {
            deleteArtist(record);
        });
        var y = $('<button>').text('Edit Record').click(function () {
            editRecord(record);
        });
        $artistInfo.append(x)
        $artistInfo.append(y)
        $artistInfo.attr('data-record-id', record.getId());

        $('#artists').append($artistInfo);
    }

    var loadArtists = function () {
        $('#artists').empty();

        base('Artists')
            .select({
                sort: [
                    { field: 'Name', direction: 'asc' }
                ]
            })
            .eachPage(function page(records, fetchNextPage) {
                records.forEach(function (record) {
                    renderRecord(record)
                });

                fetchNextPage();
            }, function done(error) {
                console.log(error);
            });
    };




    $('#buttonToCreateArtist').click(function () {
        var newRecord = {
            "Name": $('#artistName').val(),
            "Bio": $('#artistBio').val(),
            "Genre": $('#artistGenre').val(),
            "On Display?": $('#artistOnDisplay').prop('checked')
        }
        base('Artists')
            .create(
                newRecord
                , function (err, record) {
                    if (err) {
                        console.log('Error updating ', selectedRecordId, err);
                    } else {
                        console.log('Updated ', record.getId());
                        loadArtists();
                    }
                }
            );
    });

    loadArtists();

    // https://airtable.com/developers/web/api/get-base-schema
    // curl "https://api.airtable.com/v0/meta/bases/{baseId}/tables" \-H "Authorization: Bearer YOUR_TOKEN"



</script>

</html>
