<!DOCTYPE html>
<html>

<head>
    <script src="https://code.jquery.com/jquery-1.12.2.min.js"></script>
    <script src="airtable.browser.js"></script>
</head>

<body>
    <h1>Artists</h1>
    <hr />
    <fieldset>
        <legend>
            <span id="operationTypeUpdate">
                Update
            </span>
            <span id="operationTypeCreate">
                Create
            </span>
            Artist Record
            <span id="recordId"></span>
        </legend>
        <div id="inputs">
        </div>
        <br>
        <button id='buttonToCreateArtist'>Create</button>
        <button id="buttonToUpdateArtist">Update</button>
        <button id="buttonToClearFieldSet">Clear</button>
    </fieldset>
    <hr />
    <table>
        <thead id="artistTableHead"></thead>
        <tbody id="artists"></tbody>
    </table>
    <hr>

</body>

<style>
    body {
        font-family: 'San Francisco', 'Helvetica Neue', Arial, sans-serif;
        color: #333;
        background-color: #fff;
        margin: 0;
        padding: 0;
    }

    h1 {
        font-weight: 300;
        text-align: center;
        padding: 20px 0;
    }

    fieldset {
        margin: 0 auto;
        width: 80%;
        max-width: 600px;
        border: 2px solid #ccc;
        border-radius: 5px;
        padding: 20px;
        background-color: #f9f9f9;
    }

    #inputs {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    input,
    textarea {
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 10px;
        font-size: 16px;
    }

    .datetime-local-wrapper {
        display: flex;
        flex-direction: column;
        margin-bottom: 10px;
    }

    .datetime-local-wrapper label {
        font-weight: bold;
        margin-bottom: 5px;
    }

    .datetime-local-wrapper input {
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    button {
        background-color: #007aff;
        color: #fff;
        border: none;
        border-radius: 5px;
        padding: 10px 20px;
        font-size: 16px;
        margin: 10px 0;
        cursor: pointer;
    }

    button:hover {
        background-color: #0051a1;
    }

    #buttonToClearFieldSet {
        background-color: #cccccc;
        color: #000;
    }

    .actions-wrapper {
        display: flex;
        gap: 10px;
    }


    .button-to-delete {
        background-color: #ff3b30;
        color: #fff;
    }



    .button-to-delete:hover {
        background-color: #e32f24;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }

    thead {
        position: sticky;
        top: 0;
        background-color: #fff;
        /* Add a background color to the thead */
        z-index: 10;
        /* Ensure it sits on top of other elements */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    table,
    th,
    td {
        border: 1px solid #ccc;
    }

    th,
    td {
        padding: 10px;
        text-align: left;
    }

    .images-wrapper {
        display: flex;
        gap: 10px;
    }
</style>

<script>
    // find the apiKey here https://airtable.com/create/tokens it's called a token now
    var apiKey = ''
    // find the baseId, go here https://airtable.com/developers/web/api/introduction  then click on the base you want to use and the base id is in the url
    var baseId = 'appq7pl4mHoUefVWb'
    // get base id and api key from the url
    var url = new URL(window.location.href);
    if (url.searchParams.get("api_key")) {
        apiKey = url.searchParams.get("api_key");
    }
    if (url.searchParams.get("base_id")) {
        baseId = url.searchParams.get("base_id");
    }
    // ask for api key and base id if not provided
    if (!apiKey) {
        apiKey = prompt('Enter your Airtable API key');
    }
    if (!baseId) {
        baseId = prompt('Enter your Airtable base ID');
    }
    if (!apiKey || !baseId) {
        alert('You must provide an API key and base ID to use this example.');
    }
    var Airtable = require('airtable');
    // Get a base ID for an instance of art gallery example
    var base = new Airtable({
        endpointUrl: 'https://api.airtable.com',
        apiKey: apiKey
    }).base(
        baseId
    );

    const capitalize = (s) => {
        if (typeof s !== 'string') return ''
        return s.charAt(0).toUpperCase() + s.slice(1)
    }

    const getIdOfField = (field) => {
        // return 'artist' + capitalize(field.name).replace(/\s/g, '');
        // replace everything not a letter or number with ''
        return 'artist' + field.name.replace(/[^a-zA-Z0-9]/g, '');
    }

    var renderFieldInput = function (field) {
        if (field.type === "singleLineText") {
            return $('<input>').attr('type', 'text').attr('id', getIdOfField(field)).attr('placeholder', field.name);
        } else if (field.type === "multilineText") {
            return $('<textarea>').attr('id', getIdOfField(field)).attr('placeholder', field.name);
        } else if (field.type === "multipleSelects") {
            return $('<select>')
                .attr('id', getIdOfField(field))
                .attr('multiple', true)
                .attr('size',
                    field.options.choices.length
                )
        } else if (field.type === "checkbox") {
            return $('<span>').attr('class', 'checkbox-wrapper').append($('<input>').attr('type', 'checkbox').attr('id', getIdOfField(field))).append($('<label>').attr('for', getIdOfField(field)).text(field.name));
        } else if (field.type === "lastModifiedTime") {
            var div = $('<div class="datetime-local-wrapper">');
            var label = $('<label>').attr('for', getIdOfField(field)).text(field.name);
            var input = $('<input>').attr('type', 'datetime-local').attr('id', getIdOfField(field)).attr('disabled', true);

            div.append(label);
            div.append(input);

            return div;
        } else if (field.type === "createdTime") {
            var div = $('<div class="datetime-local-wrapper">');
            var label = $('<label>').attr('for', getIdOfField(field)).text(field.name);
            var input = $('<input>').attr('type', 'datetime-local').attr('id', getIdOfField(field)).attr('disabled', true);

            div.append(label);
            div.append(input);

            return div;
        }
    }

    var renderFieldsInputs = function (fields) {
        $('#inputs').empty();
        fields.forEach(function (field) {
            $('#inputs').append(renderFieldInput(field));
        });
    }

    var genres = []
    var tableFields = []
    var tableFieldsNames = []

    // https://airtable.com/developers/web/api/get-base-schema
    // curl "https://api.airtable.com/v0/meta/bases/{baseId}/tables" \-H "Authorization: Bearer YOUR_TOKEN"

    var getTables = async function () {
        let data = await $.ajax({
            url: 'https://api.airtable.com/v0/meta/bases/' + baseId + '/tables',
            type: 'GET',
            headers: {
                'Authorization': 'Bearer ' + apiKey
            }
        });

        console.log('tables', data);
        renderFieldsInputs(data.tables[0].fields);
        tableFields = data.tables[0].fields;
        tableFieldsNames = data.tables[0].fields.map(f => f.name);
        if (!tableFieldsNames.includes('Updated At')) {
            alert('You must have an "Updated At" field in your table otherwise this example will not work.');
        }
        $('thead').empty();
        tableFieldsNames.forEach(function (field) {
            $('thead').append($('<th>').text(field));
        });
        $('thead').append($('<th>').text('Actions'))
        genres = data.tables[0]
            .fields
            .find(function (field) {
                return field.name === 'Genre';
            })
            ?.options.choices.map(c => c.name);
        console.log('genres', genres);
        $('#artistGenre').empty();
        genres.forEach(function (genre) {
            $('#artistGenre').append($('<option>').val(genre).text(genre));
        });
    }


    var deleteArtist = function (record) {
        var sure = confirm('Are you sure you want to delete ' + record.get('Name') + '?');
        if (!sure) {
            return;
        }
        record.destroy(function (err) {
            if (err) {
                console.log('Error destroying ', recordId, err);
            } else {
                console.log('Destroyed ', record.getId());
                $('[data-record-id="' + record.getId() + '"]').remove();
            }
        });
    };

    var updateArtist = function () {
        var updatedRecord = {
            "Name": $('#artistName').val(),
            "Bio": $('#artistBio').val(),
            "Genre": $('#artistGenre').val(),
            "On Display?": $('#artistOnDisplay').prop('checked')
        }
        base('Artists')
            .update(
                selectedRecordId,
                updatedRecord
                , function (err, record) {
                    if (err) {
                        console.log('Error updating ', selectedRecordId, err);
                    } else {
                        console.log('Updated ', record.getId());
                        rerender()
                    }
                }
            );
    };

    $('#buttonToUpdateArtist').click(function () {
        updateArtist();
    });



    var clearFieldSet = function () {
        $('#operationTypeUpdate').hide();
        $('#operationTypeCreate').show();
        $('#buttonToUpdateArtist').hide();
        $('#buttonToCreateArtist').show();
        selectedRecordId = null;
        $('#recordId').text('');
        $('#artistName').val('');
        $('#artistBio').val('');
        $('#artistGenre').val('');
        $('#artistOnDisplay').prop('checked', false);
        $('#artistCreatedAt').val('');
        $('#artistUpdatedAt').val('');
    };

    clearFieldSet();

    $('#buttonToClearFieldSet').click(function () {
        clearFieldSet();
    });

    var selectedRecordId = null;

    function convertTimeForInputWithUTCOffset(
        dateTimeString
        // example: 2024-03-16T19:53:46.000Z
    ) {
        const date = new Date(dateTimeString);
        const options = {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false,
            timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
        };
        console.log(date)
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        const formattedDate = `${year}-${month}-${day}T${hours}:${minutes}`
        return formattedDate;
    }

    var editRecord = function (record) {
        $('#operationTypeUpdate').show();
        $('#operationTypeCreate').hide();
        $('#buttonToUpdateArtist').show();
        $('#buttonToCreateArtist').hide();
        selectedRecordId = record.getId();
        $('#recordId').text(selectedRecordId);
        $('#artistName').val(record.get('Name'));
        $('#artistBio').val(record.get('Bio'));
        $('#artistGenre').val(record.get('Genre'));
        $('#artistOnDisplay').prop('checked', record.get('On Display?'));
        var createdAt = convertTimeForInputWithUTCOffset(record.get('Created At'));
        $('#artistCreatedAt').val(createdAt)
        var updatedAt = convertTimeForInputWithUTCOffset(record.get('Updated At'));
        $('#artistUpdatedAt').val(updatedAt)
        window.scrollTo(0, 0);
    }

    function convertTimeToHumanReadable(
        dateTimeString
        // example: 2024-03-16T19:53:46.000Z
    ) {
        const date = new Date(dateTimeString);
        const options = {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false,
            timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
        };
        return date.toLocaleDateString(
            Intl.DateTimeFormat().resolvedOptions().locale, options
        );
    }

    const renderCell = function (record, field) {
        if (field.type === 'singleLineText') {
            var cell = $('<td>').text(record.get(field.name));
            return cell
        }
        else if (
            field.type === 'multilineText'
        ) {
            var cell = $('<td>').text(record.get(field.name));
            return cell
        }
        else if (
            field.type === 'multipleSelects'
        ) {
            var cell = $('<td>').append($('<ul>').append(record.get(field.name)?.map(g => $('<li>').text(g))))
            return cell
        } else if (
            field.type === 'checkbox'
        ) {
            var cell = $('<td>').append($('<input>').attr('type', 'checkbox').prop('checked', record.get(field.name)).prop('disabled', true));
            return cell
        } else if (
            field.type === 'lastModifiedTime'
        ) {
            var cell = $('<td>').text(convertTimeToHumanReadable(record.get(field.name)));
            return cell
        } else if (
            field.type === 'createdTime'
        ) {
            var cell = $('<td>').text(convertTimeToHumanReadable(record.get(field.name)));
            return cell
        } else if (
            field.type === 'multipleAttachments'
        ) {
            var files = record.get(field.name);
            if (files?.length > 0) {
                var cell = $('<td>')
                var imagesWrapper = $('<div class="images-wrapper">');
                cell.append(imagesWrapper);
                for (var i = 0; i < files.length; i++) {
                    var url = files[i]?.url;
                    var imgUrl = files[i]?.thumbnails?.small?.url;
                    var imgUrlLarge = files[i]?.thumbnails?.large?.url;
                    imagesWrapper.append($(`<a target="blank" href=${url}><img src="${imgUrl}"></a>`));
                }
                return cell;
            } else {
                var cell = $('<td>').attr('style', 'min-width: 36px;');
                return cell;
            }
        } else {
            return $('<td>')
        }
    }


    const renderRecord = function (record) {
        console.log('Retrieved ', record.get('Name'));

        var $artistInfo = $('<tr>');
        for (var i = 0; i < tableFields.length; i++) {
            $artistInfo.append(renderCell(record, tableFields[i]))
        }
        var actionsCol = $('<td>');
        var actions = $('<div class="actions-wrapper">');
        var y = $('<button class="button-to-edit">').text('Edit Record').click(function () {
            editRecord(record);
        });
        var x = $('<button class="button-to-delete">').text('Delete').click(function () {
            deleteArtist(record);
        });
        actions.append(y)
        actions.append(x)
        actionsCol.append(actions);
        $artistInfo.append(actionsCol);
        $artistInfo.attr('data-record-id', record.getId());

        $('#artists').append($artistInfo);
    }

    var recordsList = []

    var loadArtists = async function () {
        $('#artists').empty();
        return new Promise((resolve, reject) => {
            base('Artists')
                .select({
                    sort: [
                        { field: 'Updated At', direction: 'desc' }
                    ],
                    // pageSize: 10,
                })
                .eachPage(async function page(records, fetchNextPage) {
                    try {
                        recordsList = [...recordsList, ...records]
                        fetchNextPage();
                    } catch (error) {
                        console.error(error)
                        reject(error)
                    }
                }, function done(error) {
                    if (error) {
                        console.log('Error fetching records', error);
                        reject(error)
                    } else {
                        console.log('Retrieved ', recordsList.length, ' records');
                        resolve(recordsList)
                    }
                });
        });
    };

    const renderRecords = function () {
        recordsList.forEach(function (record) {
            renderRecord(record);
        });
    }


    $('#buttonToCreateArtist').click(function () {
        var newRecord = {
            "Name": $('#artistName').val(),
            "Bio": $('#artistBio').val(),
            "Genre": $('#artistGenre').val(),
            "On Display?": $('#artistOnDisplay').prop('checked')
        }
        base('Artists')
            .create(
                newRecord
                , function (err, record) {
                    if (err) {
                        console.log('Error updating ', selectedRecordId, err);
                        alert('Error creating record: ' + err)
                    } else {
                        console.log('Updated ', record.getId());
                        rerender();
                    }
                },

            );
    });

    const rerender = async function () {
        try {
            recordsList = []
            await loadArtists();
            await renderRecords()
        } catch (error) {
            console.error(error)
        }
    }

    const init = async function () {
        try {
            await getTables();
            rerender()
        } catch (error) {
            console.error(error)
        }
    }



    init()


</script>

</html>
